<?php
/**
 * @category   BestBuy
 * @package    BestBuy\Service\BBYOpen
 * @author     Troy McCabe <troy.mccabe@geeksquad.com>
 * @copyright  Copyright (c) 2013 {@link http://geeksquad.com Geek Squad}
 * @license    http://www.opensource.org/licenses/bsd-license.php
 * @version    $Id: BBYOpenTest.php 23 2010-01-14 15:27:13Z troymccabe $
 */

namespace BestBuy\Service\Tests;

use BestBuy\Service\BBYOpen\Client;

/**
 * Provides test cases for {@link \BestBuy\Service\BBYOpen}
 *
 * @category   BestBuy
 * @package    BestBuy\Service\BBYOpen
 * @author     Troy McCabe <troy.mccabe@geeksquad.com>
 * @copyright  Copyright (c) 2013 {@link http://geeksquad.com Geek Squad}
 */
class BBYOpenTest extends \PHPUnit_Framework_TestCase
{
    /**
     * An instance of {@link \BestBuy\Service\BBYOpen} that we can work with
     *
     * @var Client
     */
    protected $bbyOpen;

    /**
     * Sets up the required things before testings
     */
    public function setUp()
    {
        $this->bbyOpen = new Client('');
    }

    /**
     * Tests the magic method __call
     */
    public function test__Call()
    {
        $this->bbyOpen->active('false');
        $this->assertAttributeEquals(array('active' => 'false'), 'params', $this->bbyOpen);

        $this->bbyOpen->active(array('false', 'true'));
        $this->assertAttributeEquals(array('active' => 'false,true'), 'params', $this->bbyOpen);
    }

    /**
     * Tests clearing the params
     */
    public function testClear()
    {
        $this->bbyOpen->params(array('test' => 'abc'));
        $this->bbyOpen->product(123456);
        $this->bbyOpen->clear();

        $this->assertAttributeEquals(array(), 'params', $this->bbyOpen);
        $this->assertAttributeEquals(array(), 'types', $this->bbyOpen);
    }

    /**
     * Tests building the uri
     */
    public function testGetTargetUri()
    {
        $this->bbyOpen->products(array('a=b'));

        $this->assertEquals('http://api.remix.bestbuy.com/v1/products(a=b)?apiKey=', $this->bbyOpen->getTargetUri());
    }

    /**
     * Tests setting the params
     */
    public function testParams()
    {
        // test setting initially
        $params = array('a' => 'b', 'c' => 'd');
        $this->bbyOpen->params($params);
        $this->assertAttributeEquals($params, 'params', $this->bbyOpen);

        // test appending
        $newParams = array('e' => array('test', 'face'));
        $this->bbyOpen->params($newParams);
        $this->assertAttributeEquals(array('e' => 'test,face'), 'params', $this->bbyOpen);
    }

    /**
     * Tests getting a single product
     */
    public function testProduct()
    {
        $expectedUri = 'http://api.remix.bestbuy.com/v1/products/123.xml?apiKey=';
        $this->bbyOpen->product(123);

        $this->assertEquals($expectedUri, $this->bbyOpen->getTargetUri());
    }

    /**
     * Tests getting products by a filter
     */
    public function testProducts()
    {
        $expectedUri = 'http://api.remix.bestbuy.com/v1/products(sku=123)?apiKey=';
        $this->bbyOpen->products(array('sku=123'));

        $this->assertEquals($expectedUri, $this->bbyOpen->getTargetUri());
    }

    /**
     * Tests a BBYOpen query
     */
    public function testQuery()
    {
        // test the exception if we're not doing anything proper
        try {
            $this->bbyOpen->query();
        } catch (\Exception $e) {
            $this->assertInstanceOf('\BestBuy\Service\BBYOpen\Exception', $e);
        }

        // test valid search
        $this->bbyOpen->store(281);
        $this->assertInstanceOf('\BestBuy\Service\BBYOpen\Response', $this->bbyOpen->query());
    }

    /**
     * Tests the throttling control of the service
     */
    public function testRequestsPerSecond()
    {
        $this->bbyOpen->setRequestsPerSecond(2);

        $start = time();
        $this->bbyOpen->store(1)->query();
        $this->bbyOpen->store(2)->query();
        $this->bbyOpen->store(3)->query();
        $this->bbyOpen->store(4)->query();
        $this->bbyOpen->store(5)->query();
        $this->bbyOpen->store(6)->query();
        $end = time();

        $this->assertGreaterThanOrEqual(2, $end - $start);
    }

    /**
     * Tests setting requests per second
     */
    public function testSetRequestsPerSecond()
    {
        $this->bbyOpen->setRequestsPerSecond(20);

        $this->assertAttributeEquals(20, 'requestsPerSecond', $this->bbyOpen);
    }

    /**
     * Tests getting a single store
     */
    public function testStore()
    {
        $expectedUri = 'http://api.remix.bestbuy.com/v1/stores/123.xml?apiKey=';
        $this->bbyOpen->store(123);

        $this->assertEquals($expectedUri, $this->bbyOpen->getTargetUri());
    }

    /**
     * Tests getting stores by a filter
     */
    public function testStores()
    {
        $expectedUri = 'http://api.remix.bestbuy.com/v1/stores(id=123)?apiKey=';
        $this->bbyOpen->stores(array('id=123'));

        $this->assertEquals($expectedUri, $this->bbyOpen->getTargetUri());
    }

    /**
     * Tests setting the timeout
     */
    public function testSetTimeout()
    {
        // true case
        $this->bbyOpen->setTimeout(123);
        $this->assertAttributeEquals(123, 'timeout', $this->bbyOpen);

        // testing the case of failure
        try {
            $this->bbyOpen->setTimeout('abc');
        } catch (\Exception $e) {
            $this->assertInstanceOf('\BestBuy\Service\BBYOpen\Exception', $e);
        }
    }
}